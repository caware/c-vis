<html>
<head>
    <title>WGB Energy Usage</title>
    
    <script type="text/javascript" src="libs/jquery-1.5.1.min.js"></script>
    <script src="libs/jquery.event.drag-2.0.min.js"></script>
    <script type="text/javascript" src="libs/protovis-d3.2.js"></script>
    <script src="libs/slick.core.js"></script>
    <script src="libs/slick.grid.js"></script>
    <script src="libs/slick.editors.js"></script>
    <script src="libs/slick.dataview.js"></script>
    
    <link rel="stylesheet" type="text/css" href="css/index.css" media="screen" charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.5.custom.css" media="screen" charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="css/slick.grid.css" media="screen" charset="utf-8"/>
</head>
<body>
    <div id="content">
    <div style="text-align:center;"><h2>William Gates Building Energy Usage</h2></div>
    <div style="text-align:right;padding-right:20;">
        <input name="scale" id="scalefit" type="radio" onchange="vis.render()">
        <label for="scalefit">Scale to fit</label>
        <input name="scale" id="scalezoomed" type="radio" onchange="vis.render()">
        <label for="scalezoomed">Zoom Y values</label>
        <input checked name="scale" id="scaleoriginal" type="radio" onchange="vis.render()">
        <label for="scaleoriginal">Original scale</label>
    <div style="text-align:left;padding-left:20;">
        <label for="treegeo">Explore tree by: Geography</label>
        <input checked name="treetype" id="treegeo" type="radio" onchange="tree()">
        <label for="treeuse"> Function</label>
        <input name="treetype" id="treeuse" type="radio" onchange="tree()">
    </div>
    </div>
    <div id="treediv">
    <script type="text/javascript+protovis">
        var urlArray = new Array();
        var dataArray = new Array();
        
        var plot = {"colour":"Colour", "room":"Room",
                    "circuit":"Circuit", "avgselected":10.0,
                    "avgtotal":15.0, "totalenergy":20.0}
        var plotArray = new Array(plot, plot, plot, plot, plot);
        
        tree();
        
        function tree(){
            var treeURL = "rooms.json";
            
            if (treegeo.checked){treeURL = "rooms.json";}
            else {treeURL = "uses.json";}
                
            var JSONdata = $.ajax({ type: "GET", url: treeURL,async: false }).responseText;
            var rooms = jQuery.parseJSON(JSONdata);
            var root = pv.dom(rooms)
                .root("Sensors");
            
            var treevis = new pv.Panel()
                .def("i", -1)
                .canvas("treediv")
                .width(300)
                .height(function(){ return((root.nodes().length + 1) * 24);})
                .margin(5);
            
            var layout = treevis.add(pv.Layout.Indent)
                .nodes(function() {return root.nodes();})
                .depth(24)
                .breadth(24);
            
            var nodes = root.nodes();
            for(i=0; i<nodes.length;i++){
                var nm = nodes[i].nodeName
                if (nm=="Ground"){nodes[i].toggle();}
                else if (nm=="First"){nodes[i].toggle();}
                else if (nm=="Second"){nodes[i].toggle();}
                else if (nm=="North"){nodes[i].toggle();}
                else if (nm=="South"){nodes[i].toggle();}
                else if (nm=="East"){nodes[i].toggle();}
                else if (nm=="West"){nodes[i].toggle();}
                else if (nm=="Centre"){nodes[i].toggle();}
                else if (nm=="Kitchen"){nodes[i].toggle();}
                else if (nm=="External"){nodes[i].toggle();}
                else if (nm=="Computers"){nodes[i].toggle();}
                else if (nm=="A/C"){nodes[i].toggle();}
                else if (nm=="Computers & A/C"){nodes[i].toggle();}
                else if (nm=="Lighting & Power"){nodes[i].toggle();}
                else if (nm=="Lighting"){nodes[i].toggle();}
                else if (nm=="Sockets"){nodes[i].toggle();}
            }
            
            layout.link.add(pv.Line);
            
            var node = layout.node.add(pv.Panel)
               .top(function(n){return(n.y-6);})
               .height(12)
               .right(6)
               .strokeStyle(null)
               .events("all")
               .event("mousedown", toggle);
            
            node.anchor("left").add(pv.Dot)
                .radius("7")
                .strokeStyle("#1f77b4")
                .fillStyle(function(n) n.toggled ? "#1f77b4" : n.firstChild ? "#aec7e8" : "#ff7f0e")
                .title(function t(d) d.parentNode ? (t(d.parentNode) + "." + d.nodeName) : d.nodeName)
                .anchor("right").add(pv.Label)
                .text(function(n){return n.nodeName;})
                .font("12px/14px helvetica, Arial, Sans-serif");
            
            treevis.render();
            
                function toggle(n) {
                    n.toggle(pv.event.altKey);
                    console.log(n.nodeName);
                    if(typeof n.nodeValue != "undefined"){
                        //console.log("clicked: "+n.nodeValue);
                        var chartURL = "http://www.cl.cam.ac.uk/meters/"+n.nodeValue+"2011-04.json";
                        chart(chartURL);
                        //drawgrid();
                    }
                    return layout.reset().root;
                }
            }

        var vis;
        var zoomDateFormat = pv.Format.date("%d/%m %H:%M");
        var overallDateFormat = pv.Format.date("%d-%b '%y");
        
        function chart(chartURL) {
            //console.log("chartURL="+chartURL);
            // var urlArray = new Array();
            // var dataArray = new Array();
            
            var found = false;
            for(i=0; i<urlArray.length; i++){
                if(urlArray[i] == chartURL){
                    found = true;
                    urlArray.splice(i,1);
                    //console.log("alreadyhere");
                }
            }
            //console.log("found: "+found);
            if(found == false){
                //console.log("nothere");
                urlArray.push(chartURL);
            }
            
            console.log("urlArray: "+urlArray);
            
            //if url exsists in array, remove it.
            //if it doenst, add it. 
            var concatdata = new Array();
            var maxtime = 0;
            var mintime = 0;
            var maxvalue = 0.0;
            var minvalue = 0.0;
            var overalltot = 0.0;
            var overallavg = 0.0;
            
            for(i=0;i<urlArray.length;i++){
                var JSONdata = $.ajax({ type: "GET", url: chartURL,async: false }).responseText;
                //console.log("JSONdata:"+JSONdata);
                var readjson = jQuery.parseJSON(JSONdata);
                
                $('#charttitletext').text(readjson.description+" in "+readjson.room);
                
                plotArray[0].colour = "Blue";
                plotArray[0].room = readjson.room;
                plotArray[0].circuit = readjson.description;
                
                for (i=0; i<readjson.data.length; i++){
                    var tmpx = readjson.data[i][0];
                    var tmpy = readjson.data[i][1];
                    overalltot = overalltot + tmpy;
                    
                    if (concatdata.length == 0){
                        maxtime = tmpx;
                        mintime = tmpx;
                        maxvalue = tmpy;
                        minvalue = tmpy;
                    }
                    else {
                        if (tmpx > maxtime){maxtime = tmpx;}
                        else if (tmpx < mintime){mintime = tmpx;}
                        if (tmpy > maxvalue){maxvalue = tmpy;}
                        else if (tmpy < minvalue){minvalue = tmpy;}
                    }
                    concatdata = concatdata.concat({x:new Date(tmpx),y: tmpy});
                    overallavg = overalltot / readjson.data.length;
                    //console.log(dateFormat.format(new Date(tmpx)));
                }
                dataArray.push(concatdata);
            }
            
            
            $('#overallavgkwh').text('Average power for entire data set: '+(Math.round(overallavg*1000)/1000)+" kW.");
            $('#overalltotkwh').text('Total energy in data set: '+(Math.round(overalltot*1000)/1000)+" kWh.");
            plotArray[0].avgtotal = Math.round(overallavg*1000)/1000;
            plotArray[0].totalenergy = Math.round(overalltot*1000)/1000;
            
            //console.log("DataArray: "+dataArray);
            //concatdata = dataArray[0].data;
            
            //var plot = {"colour":"Colour", "room":"Room",
            //        "circuit":"Circuit", "avgselected":10.0,
            //        "avgtotal":15.0, "totalenergy":20.0}
            //var plotArray = new Array(plot, plot, plot, plot, plot);
            //
            //console.log("concatdata length:"+concatdata.length);
            //console.log("Concat Data 0-x:"+concatdata[0].y);
            
            var start = new Date(concatdata[0].x);
            //var start = new Date(1990, 0, 1);
            var year = 1000 * 60 * 60 * 24 * 365;
            var data = concatdata; //pv.range(0, 20, .02).map(function(x) {
            //    return {x: new Date(start.getTime() + year * x),
            //            y: (1 + .1 * (Math.sin(x * 2 * Math.PI))
            //                + Math.random() * .1) * Math.pow(1.18, x)
            //                + Math.random() * .1};
            //  });
            var end = concatdata[concatdata.length - 1].x;
            
            /* Scales and sizing. */
            var w = 700,
                h1 = 300,
                h2 = 30,
                x = pv.Scale.linear(start, end).range(0, w),
                y = pv.Scale.linear(0, pv.max(data, function(d) d.y)).range(0, h2);
            
            /* Interaction state. Focus scales will have domain set on-render. */
            var i = {x:200, dx:100},
                fx = pv.Scale.linear().range(0, w),
                fy = pv.Scale.linear().range(0, h1);
            
            /* Root panel. */
            vis = new pv.Panel()
                .canvas("chartdiv")
                .width(w)
                .height(h1 + 20 + h2)
                .bottom(20)
                .left(30)
                .right(20)
                .top(5);
            
            /* Focus panel (zoomed in). */
            var focus = vis.add(pv.Panel)
                .def("init", function() {
                    var d1 = x.invert(i.x),
                        d2 = x.invert(i.x + i.dx),
                        dd = data.slice(Math.max(0, pv.search.index(data, d1, function(d) d.x) - 1),
                            pv.search.index(data, d2, function(d) d.x) + 1);
                    fx.domain(d1, d2);
                    //fy.domain(scale.checked ? [0, pv.max(dd, function(d) d.y)] : y.domain());
                    
                    
                    var tot = 0;
                    for(a=0;a<dd.length;a++){
                        tot = tot + dd[a].y;
                    }
                    console.log("total: "+tot);
                    console.log("data.slice: "+dd.length);
                    var avg = tot / dd.length;
                    var roundavg = Math.round(avg*1000)/1000;
                    console.log("Average usage: "+roundavg);
                    
                    $('#averagekwh').text('Average power for selected region: '+roundavg+" kW.");
                    plotArray[0].avgselected = roundavg;
                    console.log("in innit, PA: "+plotArray[0].avgselected);
                    drawgrid();
                    
                    if (scalefit.checked){
                        fy.domain([0, (pv.max(dd, function(d) d.y) * 1.01) ]);
                    }
                    else if (scalezoomed.checked){
                        fy.domain([
                            (pv.min(dd, function(d) d.y) / 1.01),
                            (pv.max(dd, function(d) d.y) * 1.01)
                        ]);
                    }
                    else if (scaleoriginal.checked){fy.domain(y.domain());}
                    
                    return dd;
                })
                .top(0)
                .height(h1);
            
            /* X-axis ticks. */
            focus.add(pv.Rule)
                .data(function(){return fx.ticks();})
                .left(fx)
                .strokeStyle("#eee")
                .anchor("bottom").add(pv.Label)
                .text(function(fx){ return zoomDateFormat.format(fx);});
            
            /* Y-axis ticks. */
            focus.add(pv.Rule)
                .data(function() fy.ticks(7))
                .bottom(fy)
                .strokeStyle(function(d) d ? "#aaa" : "#000")
                .anchor("left").add(pv.Label)
                .text(fy.tickFormat);
            
            /* Focus area chart. */
            focus.add(pv.Panel)
                .overflow("hidden")
            .add(pv.Area)
                .data(function() focus.init())
                .left(function(d) fx(d.x))
                .bottom(1)
                .height(function(d) fy(d.y))
                .fillStyle("lightsteelblue")
            .anchor("top").add(pv.Line)
                .fillStyle(null)
                .strokeStyle("steelblue")
                .lineWidth(2);
            
            /* Context panel (zoomed out). */
            var context = vis.add(pv.Panel)
                .bottom(0)
                .height(h2);
            
            /* X-axis ticks. */
            context.add(pv.Rule)
                .data(x.ticks())
                .left(x)
                .strokeStyle("#eee")
            .anchor("bottom").add(pv.Label)
                .text(function(x){ return overallDateFormat.format(x); });
            
            /* Y-axis ticks. */
            context.add(pv.Rule)
                .bottom(0);
            
            /* Context area chart. */
            context.add(pv.Area)
                .data(data)
                .left(function(d) x(d.x))
                .bottom(1)
                .height(function(d) y(d.y))
                .fillStyle("lightsteelblue")
            .anchor("top").add(pv.Line)
                .strokeStyle("steelblue")
                .lineWidth(2);
            
            /* The selectable, draggable focus region. */
            context.add(pv.Panel)
                .data([i])
                .cursor("crosshair")
                .events("all")
                .event("mousedown", pv.Behavior.select())
                .event("select", focus)
            .add(pv.Bar)
                .left(function(d) d.x)
                .width(function(d) d.dx)
                .fillStyle("rgba(255, 128, 128, .4)")
                .cursor("move")
                .event("mousedown", pv.Behavior.drag())
                .event("drag", focus);
            
            console.log("bottom chart() PA: "+plotArray[0].avgselected);
            vis.render();
            drawgrid();
        }
        
        var grid;
        
        var columns = [
            {id:"PlotColour", name:"Colour", field:"PlotColour"},
            {id:"Room", name:"Room", field:"Room"},
            {id:"Circuit", name:"Circuit", field:"Circuit"},
            {id:"StartMonth", name:"StartMonth", field:"StartMonth", options:"Jan,Feb.Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec", editor:SelectCellEditor},
            {id:"EndMonth", name:"EndMonth", field:"EndMonth"},
            {id:"kWSelected", name:"Avg Power Selected (kW)", field:"kWSelected"},
            {id:"kWTotal", name:"Avg Power Total (kW)", field:"kWTotal"},
            {id:"TotalEnergy", name:"Total Energy (kWh)", field:"TotalEnergy"},
        ];
        
        var options = {
            enableCellNavigation: true,
            enableColumnReorder: false,
            asyncEditorLoading: true,
            editable: true
        };
        
        function SelectCellEditor(args) {
            var $select;
            var defaultValue;
            var scope = this;
            
            this.init = function() {
                
                if(args.column.options){
                    opt_values = args.column.options.split(',');
                }else{
                    opt_values ="yes,no".split(',');
                }
                option_str = ""
                for( i in opt_values ){
                    v = opt_values[i];
                    option_str += "<OPTION value='"+v+"'>"+v+"</OPTION>";
                }
                $select = $("<SELECT tabIndex='0' class='editor-select'>"+ option_str +"</SELECT>");
                $select.appendTo(args.container);
                $select.focus();
            };
            
            this.destroy = function() {
                $select.remove();
            };
            
            this.focus = function() {
                $select.focus();
            };
            
            this.loadValue = function(item) {
                defaultValue = item[args.column.field];
                $select.val(defaultValue);
            };
            
            this.serializeValue = function() {
                if(args.column.options){
                    return $select.val();
                }else{
                    return ($select.val() == "yes");
                }
            };
            
            this.applyValue = function(item,state) {
                item[args.column.field] = state;
            };
            
            this.isValueChanged = function() {
                return ($select.val() != defaultValue);
            };
            
            this.validate = function() {
                return {
                    valid: true,
                    msg: null
                };
            };
            
            this.init();
        }
        
        function drawgrid() {
            dataView = new Slick.Data.DataView();
            
            //console.log("@ draw time plotArray:" + plotArray[0].avgselected);
        
        //var plot = {"colour":"Colour", "room":"Room",
        //            "circuit":"Circuit", "avgselected":10.0,
        //            "avgtotal":15.0, "totalenergy":20.0}
        //var plotArray = new Array(plot, plot, plot, plot, plot);
        
            var data = [];
            for (var i = 0; i < 5; i++) {
                data[i] = {
                    id:i,
                    PlotColour: plotArray[0].colour,
                    Room: plotArray[0].room,
                    Circuit: plotArray[0].circuit,
                    StartMonth: "Feb",
                    EndMonth: "Sep",
                    kWSelected: plotArray[0].avgselected,
                    kWTotal: plotArray[0].avgtotal,
                    TotalEnergy: plotArray[0].totalenergy
                };
            }
            
            grid = new Slick.Grid("#myGrid", dataView, columns, options);
            
            dataView.beginUpdate();
			dataView.setItems(data);
			dataView.endUpdate();
            
            grid.render();
            
            $("#myGrid").show();
        }
    </script>
    </div>
    <div id="charttitle">
        <p id="charttitletext"></p>
    </div>
    <div id="chartcontainer">
        <div id="chartdiv">
        </div>
    </div>
    <div id="chartinfo">
        <p class="chartinformation" id="averagekwh"></p>
        <p class="chartinformation" id="overallavgkwh"></p>
        <p class="chartinformation" id="overalltotkwh"></p>
    <div id="myGrid">
        </div>
    </div>
    </div>
</body>
</html>