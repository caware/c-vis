<html>
<head>
    <script type="text/javascript" src="jquery-1.5.1.min.js"></script>
    <script type="text/javascript" src="protovis-r3.2.js"></script>
    <link rel="stylesheet" type="text/css" href="index.css" />
</head>
<body>
    <h1>William Gates Building Energy Usage</h1>
    <div id="content">
    <div id="treediv">
        <script type="text/javascript+protovis">
            var treeURL = "rooms.json";
            var JSONdata = $.ajax({ type: "GET", url: treeURL,async: false }).responseText;
            var rooms = jQuery.parseJSON(JSONdata);
            var root = pv.dom(rooms)
                .root("Sensors")
            
            var treevis = new pv.Panel()
                .width(200)
                .height(function(){ return((root.nodes().length + 1) * 12);})
                .margin(5);
            
            var layout = treevis.add(pv.Layout.Indent)
                .nodes(function() {return root.nodes();})
                .depth(12)
                .breadth(12);
            
            var nodes = root.nodes();
            for(i=0; i<nodes.length;i++){
                var nm = nodes[i].nodeName
                if (nm=="Ground"){nodes[i].toggle();}
                else if (nm=="First"){nodes[i].toggle();}
                else if (nm=="Second"){nodes[i].toggle();}
                else if (nm=="North"){nodes[i].toggle();}
                else if (nm=="South"){nodes[i].toggle();}
                else if (nm=="East"){nodes[i].toggle();}
                else if (nm=="West"){nodes[i].toggle();}
                else if (nm=="Centre"){nodes[i].toggle();}
            }
            
            layout.link.add(pv.Line);
            
            var node = layout.node.add(pv.Panel)
               .top(function(n){return(n.y-6);})
               .height(12)
               .right(6)
               .strokeStyle(null)
               .events("all")
               .event("mousedown", toggle);
            
            node.anchor("left").add(pv.Dot)
                .strokeStyle("#1f77b4")
                .fillStyle(function(n) n.toggled ? "#1f77b4" : n.firstChild ? "#aec7e8" : "#ff7f0e")
                .title(function t(d) d.parentNode ? (t(d.parentNode) + "." + d.nodeName) : d.nodeName)
                .anchor("right").add(pv.Label)
                .text(function(n){return n.nodeName;});
            
            treevis.render();
            
            function toggle(n) {
                n.toggle(pv.event.altKey);
                if(typeof n.nodeValue != "undefined"){
                    console.log("clicked: "+n.nodeValue);
                    var chartURL = "http://www.cl.cam.ac.uk/~pb22/meters.cl.cam.ac.uk/"+n.nodeValue+"2011-03.json";
                    chart(chartURL);
                }
                return layout.reset().root;
            }
        </script>
    </div>
    <div id="chartdiv">
        <script type="text/javascript">
        function chart(chartURL) {
            
            console.log(chartURL);
            
            var concatdata = new Array();
            var maxtime = 0;
            var mintime = 0;
            var maxvalue = 0.0;
            var minvalue = 0.0;
            
            var JSONdata = $.ajax({ type: "GET", url: chartURL,async: false }).responseText;
            var readjson = jQuery.parseJSON(JSONdata);
            
            for (i=0; i<readjson.data.length; i++){
                var tmpx = readjson.data[i][0];
                var tmpy = readjson.data[i][1];
                if (concatdata.length == 0){
                    maxtime = tmpx;
                    mintime = tmpx;
                    maxvalue = tmpy;
                    minvalue = tmpy;
                }
                else {
                    if (tmpx > maxtime){maxtime = tmpx;}
                    else if (tmpx < mintime){mintime = tmpx;}
                    if (tmpy > maxvalue){maxvalue = tmpy;}
                    else if (tmpy < minvalue){minvalue = tmpy;}
                }
                concatdata = concatdata.concat({x:new Date(tmpx),y: tmpy});
            }
            
            console.log("concatdata length:"+concatdata.length);
            console.log("Concat Data 0-x:"+concatdata[0].y);
            
            var gap = 0;
            var width = 600;
            var height = 200;
            var x = pv.Scale.linear(concatdata, function(d){ return d.x;}).range(0, width);
            var y = pv.Scale.linear(0, maxvalue*1.1).range(0, height);
            
            var vis = new pv.Panel()
                .canvas("chartdiv")
                .width(width)
                .height(height+5)
                .bottom(200)
                .left(40)
                .right(10)
                .top(5);
            
            vis.add(pv.Rule) //Bottom Ticks
                .data(x.ticks())
                .visible(function(d){return d>0;})
                .left(x)
                .strokeStyle("#eee")
            .add(pv.Rule) //Bottom Rule
                .bottom(-10)
                .height(5)
                .visible(function(d){return d>0;})
                .strokeStyle("#000")
            .anchor("bottom").add(pv.Label) // Bottom Text
                .text(x.tickFormat)
                .textBaseline(-200);
            
            vis.add(pv.Rule) //Left Hand Rule
                .data(y.ticks())
                .bottom(y)
                .strokeStyle(function (d){return d ? "#eee" : "#000";})
                .anchor("left").add(pv.Label)
                .text(y.tickFormat);
            
            vis.add(pv.Line)
                .data(concatdata)
                .left(function(d){return x(d.x);})
                .bottom(function(d){return  y(d.y);})
                .lineWidth(2);
            
            //setInterval(function() vis.render(), 35);
            vis.render();
            console.log("made Y Rules");
        }
        </script>
    </div>
    </div>
</body>
</html> 
