<html>
  <head>
    <title>Focus + Context</title>
    <script type="text/javascript" src="jquery-1.5.1.min.js"></script>
    <script type="text/javascript" src="protovis-r3.2.js"></script>
    <link rel="stylesheet" type="text/css" href="index.css" />
  </head>
  <body>
      <div id="content">
    <div style="text-align:right;padding-right:20;">
      <input checked id="scale" type="checkbox" onchange="vis.render()">
      <label for="scale">Scale to fit</label>
    </div>
    <div id="treediv">
        <script type="text/javascript+protovis">
            var treeURL = "rooms.json";
            var JSONdata = $.ajax({ type: "GET", url: treeURL,async: false }).responseText;
            var rooms = jQuery.parseJSON(JSONdata);
            var root = pv.dom(rooms)
                .root("Sensors")
            
            var treevis = new pv.Panel()
                .width(200)
                .height(function(){ return((root.nodes().length + 1) * 12);})
                .margin(5);
            
            var layout = treevis.add(pv.Layout.Indent)
                .nodes(function() {return root.nodes();})
                .depth(12)
                .breadth(12);
            
            var nodes = root.nodes();
            for(i=0; i<nodes.length;i++){
                var nm = nodes[i].nodeName
                if (nm=="Ground"){nodes[i].toggle();}
                else if (nm=="First"){nodes[i].toggle();}
                else if (nm=="Second"){nodes[i].toggle();}
                else if (nm=="North"){nodes[i].toggle();}
                else if (nm=="South"){nodes[i].toggle();}
                else if (nm=="East"){nodes[i].toggle();}
                else if (nm=="West"){nodes[i].toggle();}
                else if (nm=="Centre"){nodes[i].toggle();}
            }
            
            layout.link.add(pv.Line);
            
            var node = layout.node.add(pv.Panel)
               .top(function(n){return(n.y-6);})
               .height(12)
               .right(6)
               .strokeStyle(null)
               .events("all")
               .event("mousedown", toggle);
            
            node.anchor("left").add(pv.Dot)
                .strokeStyle("#1f77b4")
                .fillStyle(function(n) n.toggled ? "#1f77b4" : n.firstChild ? "#aec7e8" : "#ff7f0e")
                .title(function t(d) d.parentNode ? (t(d.parentNode) + "." + d.nodeName) : d.nodeName)
                .anchor("right").add(pv.Label)
                .text(function(n){return n.nodeName;});
            
            treevis.render();
            
            function toggle(n) {
                n.toggle(pv.event.altKey);
                if(typeof n.nodeValue != "undefined"){
                    console.log("clicked: "+n.nodeValue);
                    var chartURL = "http://www.cl.cam.ac.uk/~pb22/meters.cl.cam.ac.uk/"+n.nodeValue+"2011-03.json";
                    chart(chartURL);
                }
                return layout.reset().root;
            }
        </script>
    </div>
    <div id="chartcontainer">
    <div id="chartdiv">
    <script type="text/javascript+protovis">
    //chart("http://www.cl.cam.ac.uk/~pb22/meters.cl.cam.ac.uk/elec/S-m257-2011-03.json");
    
    var vis;
    var zoomDateFormat = pv.Format.date("%d/%m %H:%M");
    var overallDateFormat = pv.Format.date("%d-%b '%y");
    function chart(chartURL) {
    console.log(chartURL);
            var concatdata = new Array();
            var maxtime = 0;
            var mintime = 0;
            var maxvalue = 0.0;
            var minvalue = 0.0;
            
            var JSONdata = $.ajax({ type: "GET", url: chartURL,async: false }).responseText;
            var readjson = jQuery.parseJSON(JSONdata);
            
            for (i=0; i<readjson.data.length; i++){
                var tmpx = readjson.data[i][0];
                var tmpy = readjson.data[i][1];
                if (concatdata.length == 0){
                    maxtime = tmpx;
                    mintime = tmpx;
                    maxvalue = tmpy;
                    minvalue = tmpy;
                }
                else {
                    if (tmpx > maxtime){maxtime = tmpx;}
                    else if (tmpx < mintime){mintime = tmpx;}
                    if (tmpy > maxvalue){maxvalue = tmpy;}
                    else if (tmpy < minvalue){minvalue = tmpy;}
                }
                concatdata = concatdata.concat({x:new Date(tmpx),y: tmpy});
                //console.log(dateFormat.format(new Date(tmpx)));
            }
            
            console.log("concatdata length:"+concatdata.length);
            console.log("Concat Data 0-x:"+concatdata[0].y);
    
var start = new Date(concatdata[0].x);
//var start = new Date(1990, 0, 1);
var year = 1000 * 60 * 60 * 24 * 365;
var data = concatdata; //pv.range(0, 20, .02).map(function(x) {
//    return {x: new Date(start.getTime() + year * x),
//            y: (1 + .1 * (Math.sin(x * 2 * Math.PI))
//                + Math.random() * .1) * Math.pow(1.18, x)
//                + Math.random() * .1};
//  });
var end = concatdata[concatdata.length - 1].x;

/* Scales and sizing. */
var w = 810,
    h1 = 300,
    h2 = 30,
    x = pv.Scale.linear(start, end).range(0, w),
    y = pv.Scale.linear(0, pv.max(data, function(d) d.y)).range(0, h2);

/* Interaction state. Focus scales will have domain set on-render. */
var i = {x:200, dx:100},
    fx = pv.Scale.linear().range(0, w),
    fy = pv.Scale.linear().range(0, h1);

/* Root panel. */
vis = new pv.Panel()
    .canvas("chartdiv")
    .width(w)
    .height(h1 + 20 + h2)
    .bottom(20)
    .left(30)
    .right(20)
    .top(5);

/* Focus panel (zoomed in). */
var focus = vis.add(pv.Panel)
    .def("init", function() {
        var d1 = x.invert(i.x),
            d2 = x.invert(i.x + i.dx),
            dd = data.slice(
                Math.max(0, pv.search.index(data, d1, function(d) d.x) - 1),
                pv.search.index(data, d2, function(d) d.x) + 1);
        fx.domain(d1, d2);
        fy.domain(scale.checked ? [0, pv.max(dd, function(d) d.y)] : y.domain());
        return dd;
      })
    .top(0)
    .height(h1);

/* X-axis ticks. */
focus.add(pv.Rule)
    .data(function(){
        return fx.ticks();
        })
    .left(fx)
    .strokeStyle("#eee")
  .anchor("bottom").add(pv.Label)
    .text(function(fx){
        return zoomDateFormat.format(fx); //fx.tickFormat);
        });

/* Y-axis ticks. */
focus.add(pv.Rule)
    .data(function() fy.ticks(7))
    .bottom(fy)
    .strokeStyle(function(d) d ? "#aaa" : "#000")
  .anchor("left").add(pv.Label)
    .text(fy.tickFormat);

/* Focus area chart. */
focus.add(pv.Panel)
    .overflow("hidden")
  .add(pv.Area)
    .data(function() focus.init())
    .left(function(d) fx(d.x))
    .bottom(1)
    .height(function(d) fy(d.y))
    .fillStyle("lightsteelblue")
  .anchor("top").add(pv.Line)
    .fillStyle(null)
    .strokeStyle("steelblue")
    .lineWidth(2);

/* Context panel (zoomed out). */
var context = vis.add(pv.Panel)
    .bottom(0)
    .height(h2);

/* X-axis ticks. */
context.add(pv.Rule)
    .data(x.ticks())
    .left(x)
    .strokeStyle("#eee")
  .anchor("bottom").add(pv.Label)
    .text(function(x){
        return overallDateFormat.format(x);
        }); //x.tickFormat);

/* Y-axis ticks. */
context.add(pv.Rule)
    .bottom(0);

/* Context area chart. */
context.add(pv.Area)
    .data(data)
    .left(function(d) x(d.x))
    .bottom(1)
    .height(function(d) y(d.y))
    .fillStyle("lightsteelblue")
  .anchor("top").add(pv.Line)
    .strokeStyle("steelblue")
    .lineWidth(2);

/* The selectable, draggable focus region. */
context.add(pv.Panel)
    .data([i])
    .cursor("crosshair")
    .events("all")
    .event("mousedown", pv.Behavior.select())
    .event("select", focus)
  .add(pv.Bar)
    .left(function(d) d.x)
    .width(function(d) d.dx)
    .fillStyle("rgba(255, 128, 128, .4)")
    .cursor("move")
    .event("mousedown", pv.Behavior.drag())
    .event("drag", focus);

vis.render();
}
    </script>
  </div></div></div></body>
</html>