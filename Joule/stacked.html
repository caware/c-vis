<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="">
    <meta name="author" content="Chris Elsmore">
    <title>Joule - An Energy Data Visualisation Tool from the C-Aware Project</title>
    
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <link rel="stylesheet" type="text/css" href="css/index.css" media="screen" charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.5.custom.css" media="screen" charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="css/slick.grid.css" media="screen" charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="css/grid.css" media="screen" charset="utf-8"/>
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrapCustoms.css" rel="stylesheet">
    
    <script type="text/javascript" src="js/spin.js"></script>
    
    <link rel="shortcut icon" href="images/favicon.ico">
    <!-- <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
    
</head>
<body>
    <!--[if IE]>
        <div id="topbar">
            <p class="alert">This tool does not support Internet Explorer. However you can use the tool if you install Google Chrome Frame within Internet Explorer. For more information: <a href="http://www.google.com/chromeframe">http://www.google.com/chromeframe</a>.</p>
            <p class="alert">Alternatively you may use another broswer such as <a href="http://www.google.com/chrome/">Chrome</a>, <a href="http://www.mozilla.com/">Firefox</a> or <a href="http://www.apple.com/safari/">Safari</a>.</p>
        </div>
    <![endif]-->
    
    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="/">Joule @ CL</a>
          <ul class="nav">
            <li class="dropdown" data-dropdown="dropdown">
              <a href="#" class="dropdown-toggle">Deployments</a>
              <ul class="dropdown-menu">
                <li class="active" ><a href="#WGB">William Gates Bld</a></li>
                <li><a href="#SE18">SE18 Server Room</a></li>
              </ul>
            </li>
          </ul>
          <ul class="nav secondary-nav">
            <li><a href="#about">About</a></li>
            <li class="dropdown" data-dropdown="dropdown">
              <a href="#" class="dropdown-toggle">Feedback</a>
              <ul class="dropdown-menu">
                <li><a href="mailto:cce25@cl.cam.ac.uk?subject=Joule Feedback">Email</a></li>
                <li><a href="https://github.com/caware/c-vis/issues" target="_blank">GitHub Bug Report</a></li>
              </ul>
            </li>
            <li><a href="http://www.cl.cam.ac.uk/research/srg/netos/c-aware/index.html" target="_blank">C-Aware</a></li>
          </ul>
        </div>
      </div>
    </div>
    
     <div class="container">
        <div class="content">
            <div style="height:120px;">
            <ul id="v-menu" class="tabs">
                <li style="width:215px; text-align:center"><a href="index.html">Line<img src='images/lineS.jpg'/></a></li>
                <li style="width:215px; text-align:center" class='active'><a href="stacked.html">Stacked<img src='images/StackedS.jpg'/></a></li>
                
                <li style="width:215px; text-align:center"><a href="sensorinfo.html">Sensor Info<img src='images/infoS.jpg'/></a></li>
            </ul>
            </div>
            
            <div class="alert-bar" id="notify-bar">
                <noscript>
                    <div class="alert-message error">
                        <p><strong>Javascript Error!</strong> Your browser either does not support Javascript or it is not enabled. Please enable JavaScript, or update your browser (Joule works in recent versions of <a href="http://www.google.com/chrome/"><strong>Chrome</strong></a>, <a href="http://www.mozilla.com/"><strong>Firefox</strong></a> or <a href="http://www.apple.com/safari/"><strong>Safari</strong></a>).</p>
                    </div>
                </noscript>
                <div class="alert-message info">
                        <p><strong>BETA!</strong> This feature is still in beta, it may break or do otherwise unexpected things! A refresh of the page should recover should things go awry.</p>
                </div>
            </div>
            <div id="diacontainer">
                <div id="treecontainer">
                    <div id="divSpinner" style="width: 30px; float:left; padding: 20px 0px 0px 30px;">
                        
                    </div>
                    <div style="width: 260px; margin: auto;">
                        <a href="#" onclick="ui.changeTree(config.indexUrl.value, 'treegeo'); return false"><button class="btn" id="geobutton">Geographic</button></a>
                        <a href="#" onclick="ui.changeTree(config.indexUrl.value, 'treeuse'); return false"><button class="btn" id="functbutton">Functional</button></a>                        
                    </div>
                    <div id="treediv">
                        
                    </div>
                </div>
                
                <div id="chartcontainer">
                    <div id="chartdiv">
                    </div>
                </div>
                <div id="chartinfo">
                    <div id="myGrid">
                    </div>
                </div>
            </div>
        </div>
        <footer>
        <p>University Of Cambridge Computer Lab: <a href="http://www.cl.cam.ac.uk/research/srg/netos/c-aware/index.html" target="_blank">C-AWARE Project</a></p>
      </footer>

    </div> <!-- /container -->

<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.14.custom.min.js"></script>
    <script type="text/javascript" src="js/jquery.event.drag-2.0.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-dropdown.js"></script>
    <script type="text/javascript" src="js/protovis-d3.2.js"></script>
    <script type="text/javascript" src="js/date-en-GB.js"></script>
    <script type="text/javascript" src="js/slick.core.js"></script>
    <script type="text/javascript" src="js/slick.grid.js"></script>
    <script type="text/javascript" src="js/slick.editors.js"></script>
    <script type="text/javascript" src="js/slick.dataview.js"></script>
    <script type="text/javascript" src="js/caware.ColourPool.js"></script>
    <script type="text/javascript" src="js/caware.IntValueStore.js"></script>
    <script type="text/javascript" src="js/caware.PlotController.js"></script>
    <script type="text/javascript" src="js/caware.SensorAccessor.js"></script>
    <script type="text/javascript" src="js/caware.util.js"></script>
    <script type="text/javascript" src="js/caware.core.js"></script>
    <script type="text/javascript" src="js/caware.JSONCache.js"></script>
    <script type="text/javascript" src="js/WeatherJSONBridge.js"></script>
    <script type="text/javascript" src="js/caware.JouleUIController.js"></script>

<script type="text/javascript+protovis">
    var cache = new JSONCache();
    var ui = new JouleUIController();
    var config = ui.catchError(ui, cache.getObject, ["http://www.cl.cam.ac.uk/~cce25/indextest/config.json"]).config;
    
    //Date formats for chart tick labels
    var zoomDateFormat = pv.Format.date("%a %d %b");
    var zoomTimeFormat = pv.Format.date("%H:%M");
    var overallDateFormat = pv.Format.date("%d %b '%y");
    
    //Vars for array of plots, and chart visulisation
    var plotArray = new Array();
    var treeIndex = new IntValueStore();
    var plotController = new PlotController(config,ui,false);
    var sensorAccess = new SensorAccessor(config.indexUrl.value,config.sensorFilesUrl.value);
    var colourpool = new ColourPool(config.plotColour.value);
    
    var vis;
    var sensors;
    
     $(document).ready(function() {
        ui.jouleFinishedLoading(ui, 'stacked');
        //ui.loadSpin("out");
    });
    
    function tree(sensortree,type){
        //Create tree from sensor index object.
        
        //Specify the root node from the tree JS object
        var root = pv.dom(sensortree)
            .root("Sensors");
        
        //Create the root visualisation panel
        var treevis = new pv.Panel()
            .def("i", -1)
            .canvas("treediv")
            .width(380)
            .height(function(){ return((root.nodes().length + 1) * 24);})
            .margin(5);
        
        //Create the Indentation layout
        var layout = treevis.add(pv.Layout.Indent)
            .nodes(function() {return root.nodes();})
            .depth(24)
            .breadth(24);
        
        //Add nodes to the layout
        var node = layout.node.add(pv.Panel)
            .top(function(n){return(n.y-6);})
           .height(12)
           .right(6)
           .strokeStyle("none")
            .fillStyle("rgb(235, 235, 235)")
           .events("all")
           .cursor("pointer")
           .event("mousedown", toggle);
        
        node.anchor("left").add(pv.Dot)
            .radius("7")
            .shape(function(n){
                if (n.nodeName.split(" ",1)[0] == "Monitored"){return "circle";}
                //else if  == "Ground" || n.nodeName == "First" || n.nodeName == "Second" || n.nodeName == "Sensors" || n.nodeName == "Electricity"){
                //    return "triangle";
                if (!n.toggled && !n.firstChild){return "square";}
                else {return "triangle";}
            })
            .left(10)
            .angle(function(n){
                if (n.toggled){return (Math.PI*1.5); }
            })
            .strokeStyle("#999")
            .fillStyle(function(n){
                var nodedata = treeIndex.getItem(n.nodeValue);
                if (typeof nodedata != "undefined"){
                    var col = colourpool.getColour(treeIndex.getItem(n.nodeValue)[1]);
                    if (col) return col;
                }
                if (n.nodeName.split(" ",1)[0] == "Average"){return "#FFFFFE";}
                if (n.firstChild){ return "#AAAAAA"; }
                else {return "#FFFFFE";}
                return "#FF0000";
            })
            .title(function t(d) d.parentNode ? (t(d.parentNode) + "." + d.nodeName) : d.nodeName)
            .anchor("right").add(pv.Label)
                .text(function(n){return n.nodeName;})
                .font("12px/14px Helvetica, Arial, Sans-serif");
            
            
        root.sort(nodeSort);
        
        var today = new Date();
        var thismonth = today.toString("MMM")
        
        //console.log('test');
        var nodes = root.nodes();
        //console.log(nodes);
        for(var i=0; i<nodes.length;i++){
            var nm = nodes[i].nodeName
            if (nm=="Ground Floor"){nodes[i].toggle();}
            else if (nm=="First Floor"){nodes[i].toggle();}
            else if (nm=="Second Floor"){nodes[i].toggle();}
            else if (nm=="North Corridor"){nodes[i].toggle();}
            else if (nm=="South Corridor"){nodes[i].toggle();}
            else if (nm=="East Corridor"){nodes[i].toggle();}
            else if (nm=="West Corridor"){nodes[i].toggle();}
            else if (nm=="Centre Corridor"){nodes[i].toggle();}
            else if (nm=="Kitchen"){nodes[i].toggle();}
            else if (nm=="External"){nodes[i].toggle();}
            else if (nm=="Computers"){nodes[i].toggle();}
            else if (nm=="A/C"){nodes[i].toggle();}
            else if (nm=="Server Power and Server A/C"){nodes[i].toggle();}
            else if (nm=="Lighting and a/c"){
                nodes[i].toggle();
                nodes[i].nodeName = "Lighting and A/C";
            }
            else if (nm=="Lighting"){
              var childs = nodes[i].childNodes;
              childs[1].toggle();
              childs[2].toggle();
              childs[3].toggle();
            }
            else if (nm=="Condensor"){nodes[i].toggle();}
            else if (nm=="MCC"){nodes[i].toggle();}
            else if (nm=="Plant"){nodes[i].toggle();}
            else if (nm=="Sockets"){nodes[i].toggle();}
            else if (nm=="Power"){nodes[i].toggle();}
            else if (nm=="Lighting and sockets"){
                nodes[i].toggle();
                nodes[i].nodeName = "Lighting and Sockets";
            }
            else if (nm=="Kitchen power"){
                nodes[i].toggle();
                nodes[i].nodeName = "Kitchen Power";
            }
            else if (nm=="Machine room a/c"){
                nodes[i].toggle();
                nodes[i].nodeName = "Machine Room A/C";
            }
            else if (nm=="Machine room power"){
                nodes[i].toggle();
                nodes[i].nodeName = "Machine Room Power";
            }
            else if (nm=="Machine room power and a/c"){
                nodes[i].toggle();
                nodes[i].nodeName = "Machine Room Power and A/C";
            }
            else if (nm=="Lighting and server A/C"){nodes[i].toggle();}
            else if (nm=="Chiller"){nodes[i].toggle();}
            else if (nm=="Emergency Lighting"){nodes[i].toggle();}
            else if (nm=="Fire alarm and security"){
              nodes[i].toggle();
              nodes[i].nodeName = "Fire Alarm and Security";
            }
            else if (nm=="Lifts"){nodes[i].toggle();}
            else if (nm=="Machine room UPS"){
              nodes[i].toggle();
              nodes[i].nodeName = "Machine Room UPS";
            }
            else if (nm=="PABX"){nodes[i].toggle();}
            else if (nm=="a/c"){
              nodes[i].toggle();
              nodes[i].nodeName = "A/C";
            }
            
            if (nm == "Average"){
                //console.log(nodes[i]);
                //console.log(treeIndex.getItem(nodes[i].nodeValue)[1]);
                var url = treeIndex.getItem(nodes[i].nodeValue)[1];
                //console.log(url);
                var avmonth = 0;
                for (var x=0; x<url.length;x++){
                    var date = sensorAccess.getLatestReadingDate(url[x]);
                    var darray = date.split("-");
                    var avdate = Date.parse(darray[0]+"-01-"+darray[1]);
                    //console.log(avdate.toString("MMM"));
                    if(x==0){avmonth = avdate.toString("MMM")}
                    else{
                        if(avmonth != avdate.toString("MMM")){
                            avmonth = 0;
                            break;
                        }
                    }
                }
                if (avmonth == 0){
                    //console.log("NOVALID DATA");
                    nodes[i].nodeName = "Monitored Average - N/A";
                    nodes[i].nodeValue = undefined;
                }
                else {
                    nodes[i].nodeName = "Monitored Average ("+avmonth+") : "+Math.round(treeIndex.getItem(nodes[i].nodeValue)[0] * 100)/100+" kW";
                }
            }
            if (nm.slice(0,8) == "Building"){
                var url = treeIndex.getItem(nodes[i].nodeValue)[1][0];
                var date = sensorAccess.getLatestReadingDate(url);
                var darray = date.split("-");
                var avdate = Date.parse(darray[0]+"-01-"+darray[1]);
                //console.log(avdate);
                var avmonth = avdate.toString("MMM")
                //avmonth = "tmp";
                nodes[i].nodeName = nm+" Average ("+avmonth+") : "+Math.round(treeIndex.getItem(nodes[i].nodeValue)[0] * 100)/100+" kW";
            }
        }
        
        
        treevis.render();
        
        function nodeSort(node1, node2) {
            var tmp = new Array(node1.nodeName, node2.nodeName);
            //Make the Overall node always appear first
            if (tmp[0].substring(0,8) == "Building" ){
                return -1;
            }
            else if (tmp[1].substring(0,8) == "Building" ){
                return 1;
            }
            //Make the Average node always 2n @ the top
            if (tmp[0].substring(0,7) == "Average" ){
                return -1;
            }
            else if (tmp[1].substring(0,7) == "Average" ){
                return 1;
            }
            
            //tmp.sort();
            if (type == "treegeo"){
                //console.log('treegeo');
                if (tmp[0].substring(0,6) == "Ground" ){
                    return -1;
                }
                if (tmp[1].substring(0,6) == "Ground" ){
                    return 1;
                }
                if (tmp[0].substring(0,5) == "First" ){
                    return -1;
                }
                if (tmp[1].substring(0,5) == "First" ){
                    return 1;
                } 
                if (tmp[0].substring(0,6) == "Second" ){
                    return -1;
                }
                if (tmp[1].substring(0,6) == "Second" ){
                    return 1;
                }
            }
            else if (type == "treeuse"){
                if (tmp[0].substring(0,6) == "Ground" ){
                    if (tmp[1].substring(0,6) != "Second" && tmp[1].substring(0,5) != "First"){
                        return 1;
                    }
                }
                if (tmp[1].substring(0,6) == "Ground" ){
                    if (tmp[0].substring(0,6) != "Second" && tmp[0].substring(0,5) != "First"){
                        return -1;
                    }
                }
                if (tmp[0].substring(0,5) == "First" ){
                    if (tmp[1].substring(0,6) != "Second"){
                        return 1;
                    }
                }
                if (tmp[1].substring(0,5) == "First" ){
                    if (tmp[0].substring(0,6) != "Second"){
                        return -1;
                    }
                }
                if (tmp[0].substring(0,6) == "Second" ){
                    return 1
                }
                if (tmp[1].substring(0,6) == "Second" ){
                    return -1
                }
            }
            
            tmp.sort();
            if (node1.nodeName == tmp[0]){ return -1; }
            else if (node2.nodeName == tmp[0]){ return 1; }
            else if (node1.nodeName == node2.nodeName){ return 0; }
        }
        
        function toggle(n) {
            n.toggle(pv.event.altKey);
            
            //If the node clicked is a leaf node
            if ((typeof n.nodeValue != "undefined")){
                ui.treeNodeClick(n, ui);
                
                refreshTree();
                return layout.reset().root;
            }
            else{
                refreshTree();
                return layout.reset().root;
            }
        }
    }
    
    function drawChart(dataArray,start,end,maxArr,chartcount,plotcol){
        var data = dataArray;
        var chartmax = 0.0;
        for (tmpMax in maxArr){
          chartmax += maxArr[tmpMax];
        }
        //console.log(chartmax);
        //console.log(maxArr);
        
        /* Scales and sizing. */
        var w = 700,
            h1 = 310,
            h2 = 50,
            x = pv.Scale.linear(start, end).range(0, w),
            //y = pv.Scale.linear(0, pv.max(data, function(d) d.y)).range(0, h2);
            y = pv.Scale.linear(0, chartmax+1).range(0, h2);
        
        /* Interaction state. Focus scales will have domain set on-render. */
        
        var i = {x:config.zoomSize.value.zoomX, dx:config.zoomSize.value.zoomDX};
        var fx = pv.Scale.linear().range(0, w),
            fy = pv.Scale.linear().range(0, h1);
        
        /* Root panel. */
        vis = new pv.Panel()
            .canvas("chartdiv")
            .width(w)
            .height(h1 + 30 + h2)
            .bottom(20)
            .left(30)
            .right(20)
            .top(20);
        
        function datasel(id){
            d1 = x.invert(config.zoomSize.value.zoomX);
            config.zoomSize.value.zoomX = i.x;
            d2 = x.invert(config.zoomSize.value.zoomX + config.zoomSize.value.zoomDX);
            config.zoomSize.value.zoomDX = i.dx;
            
            var dd = [];
            for(var j=0; j<data.length; j++){//for each line in the data array
                dd[j] = [];
                dd[j] = (data[j].slice(Math.max(0, pv.search.index(data[j], d1, function(d) d.x) - 1),
                pv.search.index(data[j], d2, function(d) d.x) + 1));
            }
            fx.domain(d1, d2);
            if (typeof id == 'undefined'){
              //console.log(dd);
              return dd;
            }
            else {
                return dd[id];
            }
        }
        
        var grid;
        
        var columns = [
            {id:"PlotColour", name:"Colour", field:"colour", width:46, formatter:GraphicalColourCellFormatter},
            {id:"Room", name:"Room", field:"room", width:45},
            {id:"Description", name:"Description", field:"description", width:170},
            {id:"StartMonthyear", name:"Start", field:"startmonthyear", width:79},
            {id:"EndMonthyear", name:"End", field:"endmonthyear", width:79},
            {id:"kWSelected", name:"Avg kW Selected", field:"avgselected", width:115},
            {id:"kWTotal", name:"Avg kW Total", field:"avgtotal", width:95},
            {id:"TotalEnergy", name:"Total Energy (kWh)", field:"totalenergy", width:126},
            //{id:"Data", name:"Raw Data", field:"rawdata", width:50},
        ];
        
        var options = {
            //enableCellNavigation: true,
            enableColumnReorder: false,
            //asyncEditorLoading: true,
            editable: true
        };
        
        function SelectCellEditor(args) {
            var $select;
            var defaultValue;
            var scope = this;
            
            this.init = function() {
                
                if(args.column.options){
                    opt_values = args.column.options.split(',');
                }else{
                    opt_values ="yes,no".split(',');
                }
                option_str = ""
                for( i in opt_values ){
                    v = opt_values[i];
                    option_str += "<OPTION value='"+v+"'>"+v+"</OPTION>";
                }
                $select = $("<SELECT class='editor-select'>"+ option_str +"</SELECT>");
                $select.appendTo(args.container);
                $select.focus();
            };
            
            this.destroy = function() {
                $select.remove();
            };
            
            this.focus = function() {
                $select.focus();
            };
            
            this.loadValue = function(item) {
                defaultValue = item[args.column.field];
                $select.val(defaultValue);
                //console.log(defaultValue);
            };
            
            this.serializeValue = function() {
                if(args.column.options){
                    return $select.val();
                }else{
                    return ($select.val() == "yes");
                }
            };
            
            this.applyValue = function(item,state) {
                item[args.column.field] = state;
                //console.log(item+"=>"+state);
            };
            
            this.isValueChanged = function() {
                return ($select.val() != defaultValue);
            };
            
            this.validate = function() {
                return {
                    valid: true,
                    msg: null
                };
            };
            
            this.init();
        }
        
        function drawgrid() {
            dataView = new Slick.Data.DataView();
            
            grid = new Slick.Grid("#myGrid", dataView, columns, options);
            
            dataView.beginUpdate();
            dataView.setItems(plotController.getPlots());
            dataView.endUpdate();
            
            grid.render();
            
            $("#myGrid").show();
        }
        
         /* Focus panel (zoomed in). */
        var focus = vis.add(pv.Panel)
            .def("init", function() {
                date1 = new Date();
                var dd = datasel();
                var tot = 0;
                var maxy = 0;
                var miny = 0;
                
                for(var a=0;a<data.length;a++){
                    tot = 0;
                    var tmp = dd[a]
                    for(var b=0; b<tmp.length;b++){
                        tot+=tmp[b].y;
                        if(tmp[b].y > maxy){
                            maxy = tmp[b].y
                        }
                        if(b == 0 && a == 0){miny = tmp[b].y;}
                        else{
                            if(tmp[b].y < miny){miny = tmp[b].y;}
                        }
                    };
                    var avg = tot / tmp.length;
                    var roundavg = Math.round(avg*1000)/1000;
                    
                    plotController.updateAvgByIndex(a, roundavg);
                }
                    
                //$('#averagekwh').text('Average power for selected region: '+roundavg+" kW.");
                drawgrid();
                
                //if (scalefit.checked){ fy.domain([0, maxy]); }
                //else if (scalezoomed.checked){ fy.domain([miny, maxy]); }
                //else if (scaleoriginal.checked){ 
                fy.domain(y.domain());
                //}
                
                date2 = new Date();
                //console.log(date2.getMilliseconds()-date1.getMilliseconds());
                return dd;
            })
            .top(0)
            .height(h1);
            
        /* X-axis ticks. */
        focus.add(pv.Rule)
            .data(function(){return fx.ticks(7);})
            .left(fx)
            .strokeStyle(function(d) d ? "#aaa" : "#000")
            .lineWidth(function(d){
                var tmp = new Date(d);
                if (tmp.getDay() == 6 || tmp.getDay() == 1){
                    if (tmp.getHours() == 0){ return 3; }
                    else return 1;
                }
                else return 1;
            })
            .anchor("bottom").add(pv.Label)
                .text(function(fx){ return zoomTimeFormat.format(fx);});
        
        focus.add(pv.Rule)
            .data(function(){return fx.ticks(7);})
            .left(fx)
            .strokeStyle("rgba(255,255,255,0)")
            .anchor("top").add(pv.Label)
                .text(function(fx){ return zoomDateFormat.format(fx);});
        
        /* Y-axis ticks. */
        focus.add(pv.Rule)
            .data(function() fy.ticks(7))
            .bottom(fy)
            .strokeStyle(function(d) d ? "#aaa" : "#000")
            .anchor("left").add(pv.Label)
            .text(fy.tickFormat);
        
        /* Focus area chart. */
        
        panel = focus.add(pv.Panel)
            .overflow("hidden");
        
        var colVar = 0;
        //console.log(datasel());
        panel.add(pv.Layout.Stack)
          .layers(function(){ return datasel(); })
          .x(function(d){ return fx(d.x); })
          .y(function(d){ return fy(d.y); })
        .layer.add(pv.Area)
          .fillStyle(function(d){
            //colVar++;
            //console.log(colVar);
            if (colVar >= plotcol.length){
              colVar = 0;
            }
            return plotcol[colVar++];
          });
        
        /* Context panel (zoomed out). */
        var context = vis.add(pv.Panel)
            .bottom(0)
            .height(h2);
        
        /* X-axis ticks. */
        context.add(pv.Rule)
            .data(x.ticks(5))
            .left(x)
            .lineWidth(function(d){
                var tmp = new Date(d);
                if (tmp.getDay() == 6 || tmp.getDay() == 1){
                    if (tmp.getHours() == 0){ return 3; }
                    else return 1;
                }
                else return 1;
            })
            .strokeStyle("#aaa")
            .anchor("bottom").add(pv.Label)
                .text(function(l){ return overallDateFormat.format(l); });
        
        /* Y-axis ticks. */
        context.add(pv.Rule)
            .bottom(0);
        
        var totdata = [];
        
        if (data[0].length < 600) totdata = data;
        else {
            var mydiv = data[0].length / 600;
            var rounddiv = Math.round(mydiv*1)/1;
            
            for(var p=0; p<data.length; p++){
                for(var q=0; q<data[p].length;q++){
                    if (q == 0) totdata[p]=[];
                    if (q%rounddiv == 0) totdata[p].push(data[p][q]);
                }
            }
        }
        
        //for(var j=0; j<data.length; j++){
        //    context.add(pv.Line)
        //        .data(totdata[j])
        //        .left(function(d) x(d.x))
        //        .bottom(function(d) y(d.y))
        //        .strokeStyle(plotcol[j])
        //        .lineWidth(2);
        //}
        
        var colVar = 0;
        //console.log(datasel());
        context.add(pv.Layout.Stack)
          .layers(function(){ return totdata; })
          .x(function(d){ return x(d.x); })
          .y(function(d){ return y(d.y); })
        .layer.add(pv.Area)
          .fillStyle(function(d){
            //colVar++;
            //console.log(colVar);
            if (colVar >= plotcol.length){
              colVar = 0;
            }
            return plotcol[colVar++];
          });
        
        
        /* The selectable, draggable focus region. */
        context.add(pv.Panel)
            .data([i])
            .cursor("crosshair")
            .events("all")
            .event("mousedown", pv.Behavior.select())
            .event("select", focus)
        .add(pv.Bar)
            .left(function(d){ return d.x; })
            .width(function(d) d.dx)
            .fillStyle("rgba(100, 128, 255, .3)")
            .cursor("move")
            .event("mousedown", pv.Behavior.drag())
            .event("drag", focus);
        
        context.add(pv.Dot)
            .left(-15)
            .bottom(25)
            .shape("triangle")
            .angle(Math.PI*0.5)
            .size(110)
            .strokeStyle("#0069d6")
            .lineWidth(3)
            .cursor("pointer")
            .events("all")
            .event("click", function(){ui.addMonth(ui);} );
        
        vis.render();
    }
    
    </script>

  </body>
</html>
