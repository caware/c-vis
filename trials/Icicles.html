<html>
    <head>
        <title>Icicles</title>
        <link rel="stylesheet" type="text/css" href="ex.css"/>
        <script type="text/javascript" src="protovis-r3.2.js"></script>
        <script type="text/javascript" src="jquery-1.5.1.min.js"></script>
        <script type="text/javascript" src="flare.js"></script>
        <style type="text/css">
        
            #fig {
                width: 1000px;
                margin-top: 5px;
                height: 1000px;
                text-align: center;
            }
        </style>
    </head>
    <body><div id="center"><div id="fig">
    <script type="text/javascript+protovis">
        var indexUrl = "http://www.cl.cam.ac.uk/~cce25/sensorindex.json";
        var functiontree;
        
        function getJson(url){
        //Fetches a json file and returns the parsed object
            var jsonData = $.ajax({ type: "GET", url: url,async: false }).responseText;
            return jQuery.parseJSON(jsonData);
        }
        
        
        getSensors(indexUrl);
        
        function getSensors(indexfile){
        //Get the sensor index file and build the JS object tree from it.
            //var jsonData = $.ajax({ type: "GET", url: indexfile ,async: false }).responseText;
            var sensorindex = getJson(indexfile)
            
            //Get array of sensors from index file, and create blank destination object
            var elecsensors = sensorindex.sensors.elec;
            var treedata = new Object();
            
            var objcircuit = {};
            var unmetered = 0.0;
            var totalmetered = 0.0;
            var totalsensed = 0.0;
            //object to store circuits,
            for(var i=0;i<elecsensors.length;i++){
                if (elecsensors[i].sensor == "S-m257" || elecsensors[i].sensor == "S-m36"){
                    if (elecsensors[i].sensor == "S-m257"){ 
                        var recenttotal = elecsensors[i].recenttotal;
                        var datasize = elecsensors[i].datasize;
                        if (datasize > 0){ var recentaverage = recenttotal / datasize; }
                        else { var recentaverage = 0; }
                        totalmetered = recentaverage;
                    }
                }
                else {
                    var roomArray = elecsensors[i].room.split("");
                    var description = elecsensors[i].description;
                    var room = elecsensors[i].room;
                    var path = elecsensors[i].path;
                    var recenttotal = elecsensors[i].recenttotal;
                    var datasize = elecsensors[i].datasize;
                    if (datasize > 0){ var recentaverage = recenttotal / datasize; }
                    else { var recentaverage = 0; }
                    totalsensed += recentaverage;
                    var floor="";
                    //var corridor="";
                    var objroom = new Object();
                    var objfloor = new Object();
                    //console.log(roomArray);
                    switch (roomArray[0]){
                        case "G":
                            floor="Ground Floor";
                            break;
                        case "F":
                            floor="First Floor";
                            break;
                        case "S":
                            floor="Second Floor";
                            break;
                    }
                        
                    if(!(description in objcircuit)){
                        objcircuit[description] = {};
                    }
                    //else{
                    //    objcircuit[description] = recentaverage;
                    //}
                        
                    if(!(floor in objcircuit[description])){
                        objcircuit[description][floor] = {};
                    }
                    //else{
                    //    objcircuit[description][floor] = recentaverage;
                    //}
                        
                    //if (recenttotal = 0){
                    if(!(room in objcircuit[description][floor])){
                        objcircuit[description][floor][room] = recentaverage;
                        //objroom = {"Total":recenttotal};
                        //objsensor[description] = path;
                        //objcircuit[floor][corridor][room] = objsensor;                            
                        //console.log("is"+objsensor.Total);
                    }
                    else{
                        objcircuit[description][floor][room+"?2"] = recentaverage;
                        //objroom = {};
                        //objroom = objcircuit[floor][corridor][room];
                        //objsensor[description] = path;
                        console.log("Sensor "+elecsensors[i].path+" in room "+room+" already in object!");
                        //objsensor.Total += recenttotal;
                        //console.log("is now:"+objsensor.Total);
                        //objcircuit[floor][corridor][room] = objsensor;
                    }
                }
            }
            unmetered = totalmetered - totalsensed;
            //console.log(objfloor);
            //treedata.Electricity = new Object();
            objcircuit.unmetered = unmetered;
            console.log(objcircuit);
            functiontree = objcircuit;
        }
        
        
        var vis = new pv.Panel()
            .width(1000)
            .height(700)
            .bottom(30);
        
        var partition = vis.add(pv.Layout.Partition.Fill)
            .nodes(pv.dom(functiontree).root("Electricity").nodes())
            .size(function(d) d.nodeValue)
            .order("descending")
            .orient("top");
        
        partition.node.add(pv.Bar)
            .fillStyle(pv.Colors.category19().by(function(d) d.parentNode && d.parentNode.nodeName))
            .strokeStyle("#fff")
            .lineWidth(.5);
        
        partition.label.add(pv.Label)
            //.textAngle(-Math.PI / 2)
            .visible(function(d) d.dy > 6);
        
        vis.render();
        
        /* Update the layout's size method and re-render. */
        //function update(method) {
        //    switch (method) {
        //        case "byte": partition.size(function(d) d.nodeValue); break;
        //        case "file": partition.size(function(d) d.firstChild ? 0 : 1); break;
        //    }
        //    
        //    vis.render();
        //}
    </script>
    <br><b>Size:</b> <select id="menu" onchange="update(this.value)">
        <option value="byte" selected>bytes</option>
        <option value="file">files</option>
        </select>
    </div></div>
    </body>
</html>