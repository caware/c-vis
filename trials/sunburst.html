<html>
    <head>
        <title>Sunburst</title>
        <link rel="stylesheet" type="text/css" href="ex.css"/>
        <link type="text/css" rel="stylesheet" href="jquery-ui-1.8rc3.custom.css"/>
        
        <script type="text/javascript" src="protovis-r3.2.js"></script>
        <script type="text/javascript" src="jquery-1.5.1.min.js"></script>
        <script type="text/javascript" src="jquery-ui-1.8rc3.custom.min.js"></script>
        <style type="text/css">
        
            #fig {
                width: 1000px;
                margin-top: 5px;
                height: 1000px;
                text-align: center;
            }
            
            #container {
                height: 10px;
            }
           
           #timeSlider {
                position: absolute;
                left: 100;
                right: 90;
                margin-top: 3;
            }
            
            #timeLabel {
                position: absolute;
                left: 0;
                width: 85;
                text-align: right;
            }
            
            #play {
                position: absolute;
                right: 50px;
                cursor: pointer;
            }
            
        </style>
    </head>
    <body><div id="center"><div id="fig">
    <div id="container">
        <b id="timeLabel">Time (Hour):</b>
        <div id="timeSlider"></div>
        <img id="play" src="play.png" alt="Play" onclick="playClick()">
    </div>
    <script type="text/javascript+protovis">
        var indexUrl = "http://www.cl.cam.ac.uk/~cce25/sensorindex.json";
        var dataArray = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24];
        var functiontree;
        
        function getJson(url){
        //Fetches a json file and returns the parsed object
            var jsonData = $.ajax({ type: "GET", url: url,async: false }).responseText;
            return jQuery.parseJSON(jsonData);
        }
        
        function fetchSensors(indexfile){
            var todaydate = new Date();
            var year = todaydate.getFullYear();
            var month = (todaydate.getMonth()+1);
            if (month<10){
                month = "0"+month;
            }
            if (typeof indexfile === "string"){
                var sensorindex = getJson(indexfile);
                var elecsensors = sensorindex.sensors.elec;
                
                for(var i=0;i<elecsensors.length;i++){
                    var json = getJson("http://www.cl.cam.ac.uk/meters"+elecsensors[i].path+year+"-"+month+".json");
                    //var tmpsensorname = elecsensors[i].sensor;
                    //var tmpsensorsum = 0;
                    //var tmpsensordatalength = elecsensors[i].data.length;
                    //for(var j=0;j<tmpsensordatalength;j++){
                    //    tmpsensorsum += elecsensors[i].data[j][1]);
                    //    dataArray[]
                    //}
                }
            
            }
        }
        
        
        fetchSensors(indexUrl);
        
        getSensors(indexUrl);
        
        function getSensors(indexfile){
        //Get the sensor index file and build the JS object tree from it.
            //var jsonData = $.ajax({ type: "GET", url: indexfile ,async: false }).responseText;
            var sensorindex = getJson(indexfile)
            
            //Get array of sensors from index file, and create blank destination object
            var elecsensors = sensorindex.sensors.elec;
            var treedata = new Object();
            
            var objcircuit = {};
            var unmetered = 0.0;
            var totalmetered = 0.0;
            var totalsensed = 0.0;
            //object to store circuits,
            for(var i=0;i<elecsensors.length;i++){
                if (elecsensors[i].sensor == "S-m257" || elecsensors[i].sensor == "S-m36"){
                    if (elecsensors[i].sensor == "S-m257"){ 
                        var recenttotal = elecsensors[i].recenttotal;
                        var datasize = elecsensors[i].datasize;
                        if (datasize > 0){ var recentaverage = recenttotal / datasize; }
                        else { var recentaverage = 0; }
                        totalmetered = recentaverage;
                    }
                }
                else {
                    var roomArray = elecsensors[i].room.split("");
                    var description = elecsensors[i].description;
                    var room = elecsensors[i].room;
                    var path = elecsensors[i].path;
                    var recenttotal = elecsensors[i].recenttotal;
                    var datasize = elecsensors[i].datasize;
                    if (datasize > 0){ var recentaverage = recenttotal / datasize; }
                    else { var recentaverage = 0; }
                    totalsensed += recentaverage;
                    var floor="";
                    //var corridor="";
                    var objroom = new Object();
                    var objfloor = new Object();
                    //console.log(roomArray);
                    switch (roomArray[0]){
                        case "G":
                            floor="Ground Floor";
                            break;
                        case "F":
                            floor="First Floor";
                            break;
                        case "S":
                            floor="Second Floor";
                            break;
                    }
                        
                    if(!(description in objcircuit)){
                        objcircuit[description] = {};
                    }
                    //else{
                    //    objcircuit[description] = recentaverage;
                    //}
                        
                    if(!(floor in objcircuit[description])){
                        objcircuit[description][floor] = {};
                    }
                    //else{
                    //    objcircuit[description][floor] = recentaverage;
                    //}
                        
                    //if (recenttotal = 0){
                    if(!(room in objcircuit[description][floor])){
                        objcircuit[description][floor][room] = recentaverage;
                        //objroom = {"Total":recenttotal};
                        //objsensor[description] = path;
                        //objcircuit[floor][corridor][room] = objsensor;                            
                        //console.log("is"+objsensor.Total);
                    }
                    else{
                        objcircuit[description][floor][room+"?2"] = recentaverage;
                        //objroom = {};
                        //objroom = objcircuit[floor][corridor][room];
                        //objsensor[description] = path;
                        console.log("Sensor "+elecsensors[i].path+" in room "+room+" already in object!");
                        //objsensor.Total += recenttotal;
                        //console.log("is now:"+objsensor.Total);
                        //objcircuit[floor][corridor][room] = objsensor;
                    }
                }
            }
            unmetered = totalmetered - totalsensed;
            //console.log(objfloor);
            //treedata.Electricity = new Object();
            objcircuit.unmetered = unmetered;
            console.log(objcircuit);
            functiontree = objcircuit;
        }
        
        var minT = 1,
            maxT = 24
        
        $(timeSlider).slider({
            min: minT,
            max: maxT,
            value: minT,
            slide: function(e, ui) {
                time = ui.value;
                //vis.render();
                console.log(time);
            }
        });
        
        var time = 0;
        
        var w = 900,
            h = 1000,
            timeMargin = 45;
            
        var timeScale = pv.Scale.linear()
            .domain(minT, maxT)
            .range(52, w - 40);
            
        var timer = undefined;
        
        function playClick() {
            if (timer) {
                stop();
            } else {
                if (time == maxT) time = minT;
                $(timeSlider).slider('value', time);
                $(play).attr("src", 'stop.png');
                vis.render();
                timer = setInterval(function() {
                    time++;
                    if (time >= maxT) stop();
                    $(timeSlider).slider('value', time);
                    vis.render();
                }, 900);
            }
        }
        
        // Stop the animation
        function stop() {
            clearInterval(timer);
            timer = undefined;
            $(play).attr("src", 'play.png');
        }
        
        var vis = new pv.Panel()
            .width(w)
            .height(h)
            .bottom(-80)
            .top(30);
            
        vis.add(pv.Rule)
            .data(pv.range(minT, maxT + .1))
            .left(timeScale)
            .height(4)
            .top(-20)
            .anchor("bottom").add(pv.Label)
        
        var partition = vis.add(pv.Layout.Partition.Fill)
            .nodes(pv.dom(functiontree).root("Electricity").nodes())
            .size(function(d) d.nodeValue)
            .order("descending")
            .orient("radial")
            .outerRadius(400);
        
        partition.node.add(pv.Wedge)
            .fillStyle(pv.Colors.category19().by(function(d) d.parentNode && d.parentNode.nodeName))
            .strokeStyle("#fff")
            .lineWidth(.5);
        
        partition.label.add(pv.Label)
            .visible(function(d) d.angle * d.outerRadius >= 6);
        
        vis.render();
        
        /* Update the layout's size method and re-render. */
        //function update(method) {
        //    switch (method) {
        //        case "byte": partition.size(function(d) d.nodeValue); break;
        //        case "file": partition.size(function(d) d.firstChild ? 0 : 1); break;
        //    }
        //    
        //    vis.render();
        //}
    </script>
    </div></div>
    </body>
</html>